exports.id=645,exports.ids=[645],exports.modules={78466:(e,t,n)=>{Promise.resolve().then(n.bind(n,57609))},57609:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>E});var o,r=n(53854),s=n(79636),a=n(65805);let i=({startGame:e,resetGame:t,undoMove:n,forfeitGame:o})=>(0,r.jsxs)("div",{className:"flex gap-4 mt-4",children:[r.jsx(a.z,{className:"w-full",onClick:()=>e(),children:"Start Game"}),r.jsx(a.z,{className:"w-full",onClick:()=>o(),children:"Forfeit"}),r.jsx(a.z,{className:"w-full",onClick:()=>n(),children:"Undo"})]});var l=n(3314),c=n(34218),d=n.n(c),u=n(15656),m=n(94574),f=n(49458);async function h({gameID:e}){let t=await fetch(`http://fall2324w3g9.int3306.freeddns.org/api/get-timer-info/${e}`,{cache:"no-store"}).then(e=>e.json());return 200===t.status&&t.data?{ok:!0,data:t.data}:{ok:!1,error:t.error??"Get player time left error"}}function p(e,t){return{...e,...t}}function x(e){return 1!==e&&e?new u.qQ("bnnqrkrb/pppppppp/8/8/8/8/PPPPPPPP/BNNQRKRB w KQkq - 0 1"):new u.qQ}!function(e){e.Open="open",e.Connecting="connecting",e.Disconnected="disconnected"}(o||(o={}));let g=({type:e,id:t,userId:n,gameConfig:o})=>{let[r,s]=d().useState(null),[a,i]=d().useState("disconnected"),[l,u]=d().useState((o?.timeMode??0)*6e4),[g,v]=d().useState(!1),[k,w]=d().useState((o?.timeMode??0)*6e4),[y,j]=d().useState(!1),[S,b]=d().useState("unknown"),[N,C]=d().useState(0),[P,R]=d().useState([]),[O,E]=d().useState([]),M=d().useCallback(()=>{r?.close(),s(null),i("disconnected")},[r,i]);function G(e){b(e),v(!1),j(!1);let n=I.history({verbose:!0}),s=[x(o?.variant)];console.log("handle state: ",P);for(let e=0;e<n.length;e++){let t=x(o?.variant);console.log(`tempState: ${e}`,t.fen());for(let o=0;o<=e;o++)try{t.move(n[o])}catch(e){console.log("[ERR]: ",e)}s.push(t)}r?.emit("fetch-analysis",JSON.stringify({id:t})),R(s),C(s.length-1)}d().useEffect(()=>{r&&(r.connect(),r.on("connect",()=>{console.log("Connected",r.id)}),r.on("disconnect",()=>{M()}),r.on("play-chess",async e=>{console.log("Response",e);try{let t=JSON.parse(e);if(t.ok){if(t.move&&_({from:t.move.from,to:t.move.to,promotion:"q"}),3!==t.result.winner){let e=t.result.winner,n=t.result.reason;console.log("Reason: ",n),await new Promise(e=>setTimeout(e,1200)),G(0===e?"draw":1===e?"white":"black")}}else console.error("[!!!] Play chess socket error: ",t.error)}catch(e){console.error("[!!!] Play chess socket error: ",e)}}),r.on("start-game",e=>{console.log("Start game info: ",e);let t=JSON.parse(e);console.log("Given mess: ",t,t.ok),t.ok&&(v(!0),j(!1))}),r.on("end-game",e=>{console.log("clean up state: ",e)}),r.on("user-forfeit",e=>{console.log("user-forfeit socket message: ",e)}),r.on("fetch-saved-game",e=>{try{let t=JSON.parse(e);if(t.ok&&Number.isInteger(t.winner)){console.log("Res win: ",t.winner);let e="unknown";switch(t.winner){case 0:e="draw";break;case 1:e="white";case 2:e="black";default:console.log("Fetched winner: ",t.winner)}"unknown"!==e&&G(e),b(e)}else console.error("[!!!] Error when fetching saved data: ",t.error??"")}catch(e){console.error("[!!!] Can't fetch saved game data")}}),r.on("fetch-analysis",e=>{try{let t=JSON.parse(e);console.log("[RES]: ",t),Array.isArray(t.scores)&&(E(t.scores),M())}catch(e){console.error("[!!!] Can't fetch analysis",e)}}))},[M,i,r]),d().useEffect(()=>{Z();let e=localStorage.getItem(`@stockchess/useLocalStorage/${t}-moves`);if(e){let t=JSON.parse(e),n=x(o?.variant);console.log("[NEW]: ",n,n.fen());try{t.forEach(e=>n.move(e))}catch(e){console.log("[!!!] Error in initializing saved game: ",e)}D(n)}(async function(){let e=await h({gameID:t});e.ok&&e.data&&(u(1e3*e.data.w),w(1e3*e.data.b),"w"===I.turn()?(v(!0),j(!1)):(v(!1),j(!0)))})()},[]);let J=e=>{console.log("MOVE: ",e),r?.emit("play-chess",JSON.stringify({move:e,id:t}))},$=()=>{r?.emit("end-game",JSON.stringify({id:t}))},z=()=>{console.log("Running init..."),r?.emit("start-game",JSON.stringify({id:t,userId:n,config:o}))},B=()=>{r?.emit("undo",JSON.stringify({id:t}))},Z=()=>{let e=(0,m.io)("http://fall2324w3g9.int3306.freeddns.org",{autoConnect:!1,reconnection:!0});q(e),s(e)},q=e=>{console.log("Fetching saved game..."),e.emit("fetch-saved-game",JSON.stringify({id:t}))},[I,D]=(0,c.useState)(x(o?.variant)),[Q,L]=(0,f._)({name:`${t}-is-playing`,defaultValue:!1}),[F,K]=(0,f._)({name:`${t}-moves`,defaultValue:[]}),[A,V]=(0,c.useState)(),[T,U]=(0,c.useReducer)(p,{check:{}}),_=e=>{console.log(e);let t=I.move(e);if(t){let e;if(K(I.history({verbose:!0})),D(I),I.inCheck()){let t=I.board().reduce((e,t,n)=>{let o=t.findIndex(e=>e&&"k"===e.type&&e.color===I.turn());return o>=0?`${String.fromCharCode(o+97)}${8-n}`:e},"");e={[t]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}U({check:e}),"b"===I.turn()?(j(!0),v(!1)):(j(!1),v(!0))}return t},W=()=>{I.reset(),o?.variant===2&&I.load("bnnqrkrb/pppppppp/8/8/8/8/PPPPPPPP/BNNQRKRB w KQkq - 0 1"),D(I),$(),K([]),A&&clearTimeout(A),L(!1),u((o?.timeMode??0)*6e4),w((o?.timeMode??0)*6e4),j(!1),v(!1),U({check:void 0})};return{game:I,playing:Q,moves:F,winner:S,customSquares:T,wPlayerTimeLeft:l,isWPlayerActive:g,bPlayerTimeLeft:k,isBPlayerActive:y,onPieceDrop:(e,t)=>{if(!Q)return!1;let n=_({from:e,to:t,promotion:"q"});return null!==n&&(J(n.from+n.to+(n.promotion?n.promotion:"")),!0)},undoMove:()=>{B(),I.undo(),I.undo(),D(I),K(I.history({verbose:!0})),U({check:void 0})},startGame:()=>{W(),z(),L(!0)},resetGame:W,forfeitGame:()=>{r?.emit("user-forfeit",JSON.stringify({id:t})),G("black")},prevMove:()=>{let e;let t=Math.max(N-1,0),n=P[t];if(C(t),D(n),n.inCheck()){let t=n.board().reduce((e,t,o)=>{let r=t.findIndex(e=>e&&"k"===e.type&&e.color===n.turn());return r>=0?`${String.fromCharCode(r+97)}${8-o}`:e},"");e={[t]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}U({check:e})},nextMove:()=>{let e;let t=Math.min(N+1,P.length-1),n=P[t];if(C(t),D(n),n.inCheck()){let t=n.board().reduce((e,t,o)=>{let r=t.findIndex(e=>e&&"k"===e.type&&e.color===n.turn());return r>=0?`${String.fromCharCode(r+97)}${8-o}`:e},"");e={[t]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}U({check:e})},analysisMoves:O,socket:r}};var v=n(33367),k=n(71768);let w=({id:e,name:t})=>r.jsx("div",{className:"hover:opacity-60",children:r.jsx("div",{className:"w-[60px] h-[60px] border-2",children:r.jsx(k.Z,{name:t})})}),y=({botList:e,onSelectBot:t})=>(0,r.jsxs)("div",{children:[r.jsx("div",{className:"font-bold text-center pt-4",style:{fontSize:"20px"},children:"Ez Bot"}),r.jsx("div",{className:"w-auto flex row-auto pl-4 flex-wrap",children:e.map(e=>r.jsx("div",{className:"p-2",onClick:()=>{t(e)},children:r.jsx(w,{id:e.id,name:e.name})},e.id))})]});var j=n(70562);let S=({botList:e,onSelectBot:t,bot:n})=>r.jsx("div",{children:r.jsx("div",{className:"flex pt-4 pb-4",children:(0,r.jsxs)("ul",{className:"max-h-[550px] h-[550px] w-auto overflow-y-auto divide-y border rounded-lg",children:[r.jsx("div",{className:"w-[450px] text-center font-bold flex-wrap p-4",style:{fontSize:"27px"},children:"Play Chess Against a Computer"}),r.jsx("div",{className:"h-[300px]",children:r.jsx(j.Z,{id:n.id,name:n.name,inGame:!1})}),r.jsx("div",{children:r.jsx(y,{botList:e,onSelectBot:t})})]})})});var b=n(67474);let N=({timeLeft:e,going:t,turnIndicator:n})=>{let o=(0,c.useRef)(null),[s,a]=(0,c.useState)(Date.now()+e);return(0,c.useEffect)(()=>{t?o.current.start():o.current.pause()},[t]),(0,c.useEffect)(()=>{a(Date.now()+e)},[e]),r.jsx(b.ZP,{date:s,ref:o,autoStart:!1,intervalDelay:100,precision:1,renderer:({minutes:e,seconds:t,milliseconds:o})=>r.jsx("div",{className:"inline-block p-4 text-xl rounded-2xl font-mono "+(n?"bg-white":"bg-[#c8c8c8]"),children:(0,r.jsxs)("h1",{children:[(0,b.Bu)(e),":",(0,b.Bu)(t),".",o/100]})})})};var C=n(56495),P=n(90879),R=n(629),O=n(55100);let E=({id:e,type:t})=>{let n;let{userId:o,name:a}=(0,c.useContext)(O.UserContext),{game:d,playing:u,customSquares:m,winner:f,wPlayerTimeLeft:h,isWPlayerActive:p,bPlayerTimeLeft:x,isBPlayerActive:k,onPieceDrop:w,undoMove:y,startGame:j,resetGame:b,forfeitGame:E,prevMove:M,nextMove:G,analysisMoves:J}=g({type:t,id:e,userId:o,gameConfig:n}),[$,z]=(0,c.useState)([]),[B,Z]=(0,c.useState)({id:"0",name:"shark"}),[q,I]=(0,c.useState)(!0);return(0,c.useEffect)(()=>{z([{id:"0",name:"shark"},{id:"1",name:"elephant"},{id:"2",name:"owl"},{id:"3",name:"monkey"},{id:"4",name:"penguin"},{id:"5",name:"cat"}])},[]),(0,r.jsxs)("div",{className:"flex p-4 mt-8",children:[r.jsx("div",{className:"flex justify-center w-2/3",children:(0,r.jsxs)("div",{className:"w-[450px]",children:[(0,r.jsxs)("div",{className:"",children:[n?.timeMode?r.jsx(N,{timeLeft:x,going:k&&u,turnIndicator:!1}):null,r.jsx(v.Z,{name:B?B.name:"none",link:B?"/home":"/profile/guest"})]}),!u&&r.jsx("div",{className:"absolute flex justify-center items-center w-[450px] h-[450px] z-10"}),r.jsx(s.r,{id:e,onPieceDrop:w,position:d.fen(),customBoardStyle:{borderRadius:"8px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.5)"},customSquareStyles:{...m.check}}),(0,r.jsxs)("div",{className:"",children:[r.jsx(v.Z,{name:a??"Guest",link:"/profile/guest"}),n?.timeMode?r.jsx(N,{timeLeft:h,going:p&&u,turnIndicator:!0}):null]})]})}),r.jsx("div",{className:"flex justify-center w-1/3",children:(0,r.jsxs)("div",{children:[u?(0,r.jsxs)(r.Fragment,{children:[r.jsx(l.Z,{moves:d.history({verbose:!0}).reverse(),bot:B||{id:"0",name:"shark"},scores:J}),"unknown"!==f?(0,r.jsxs)("div",{className:"flex justify-center",children:[r.jsx(P.Z,{style:{fontSize:"32px"},onClick:M}),r.jsx(R.Z,{style:{fontSize:"32px"},onClick:G})]}):null]}):r.jsx(S,{botList:$,onSelectBot:e=>{Z(e)},bot:B||{id:"0",name:"shark"}}),r.jsx(i,{startGame:j,resetGame:b,forfeitGame:E,undoMove:y})]})}),"unknown"===f?null:r.jsx(C.Z,{winner:f,isOpen:q,setOpen:I})]})}},67697:(e,t,n)=>{"use strict";n.d(t,{ZP:()=>l});var o=n(95153);let r=(0,o.createProxy)(String.raw`/home/nullchilly/code/git/web101/src/components/ChessGame/ChessGame.tsx`),{__esModule:s,$$typeof:a}=r,i=r.default,l=i}};