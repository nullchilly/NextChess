(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8260],{48260:function(e,n,t){Promise.resolve().then(t.bind(t,8819))},8819:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return E}});var o,r,a=t(57437),l=t(45303),s=t(80526),i=e=>{let{startGame:n,resetGame:t,undoMove:o,forfeitGame:r}=e;return(0,a.jsxs)("div",{className:"flex gap-4 mt-4",children:[(0,a.jsx)(s.z,{className:"w-full",onClick:()=>n(),children:"Start Game"}),(0,a.jsx)(s.z,{className:"w-full",onClick:()=>r(),children:"Forfeit"}),(0,a.jsx)(s.z,{className:"w-full",onClick:()=>o(),children:"Undo"})]})},c=t(69238),d=t(2265),u=t(64755),m=t(63388),f=t(80487);async function h(e){var n;let{gameID:t}=e,o=await fetch("".concat("http://fall2324w3g9.int3306.freeddns.org")+"/api/get-timer-info/".concat(t),{cache:"no-store"}).then(e=>e.json());return 200===o.status&&o.data?{ok:!0,data:o.data}:{ok:!1,error:null!==(n=o.error)&&void 0!==n?n:"Get player time left error"}}function p(e,n){return{...e,...n}}function g(e){return 1!==e&&e?new u.qQ("bnnqrkrb/pppppppp/8/8/8/8/PPPPPPPP/BNNQRKRB w KQkq - 0 1"):new u.qQ}(o=r||(r={})).Open="open",o.Connecting="connecting",o.Disconnected="disconnected";var v=e=>{var n,t;let{type:o,id:r,userId:a,gameConfig:l}=e,[s,i]=d.useState(null),[c,u]=d.useState("disconnected"),[v,x]=d.useState((null!==(n=null==l?void 0:l.timeMode)&&void 0!==n?n:0)*6e4),[k,w]=d.useState(!1),[j,b]=d.useState((null!==(t=null==l?void 0:l.timeMode)&&void 0!==t?t:0)*6e4),[S,y]=d.useState(!1),[N,C]=d.useState("unknown"),[P,R]=d.useState(0),[O,E]=d.useState([]),M=d.useCallback(()=>{null==s||s.close(),i(null),u("disconnected")},[s,u]);function J(e){C(e),w(!1),y(!1);let n=D.history({verbose:!0}),t=[g(null==l?void 0:l.variant)];console.log("handle state: ",O);for(let e=0;e<n.length;e++){let o=g(null==l?void 0:l.variant);console.log("tempState: ".concat(e),o.fen());for(let t=0;t<=e;t++)try{o.move(n[t])}catch(e){console.log("[ERR]: ",e)}t.push(o)}E(t),R(t.length-1),M()}d.useEffect(()=>{s&&(s.connect(),s.on("connect",()=>{console.log("Connected",s.id)}),s.on("disconnect",()=>{M()}),s.on("play-chess",async e=>{console.log("Response",e);try{let n=JSON.parse(e);if(n.ok){if(n.move&&W({from:n.move.from,to:n.move.to,promotion:"q"}),3!==n.result.winner){let e=n.result.winner,t=n.result.reason;console.log("Reason: ",t),await new Promise(e=>setTimeout(e,1200)),J(0===e?"draw":1===e?"white":"black")}}else console.error("[!!!] Play chess socket error: ",n.error)}catch(e){console.error("[!!!] Play chess socket error: ",e)}}),s.on("start-game",e=>{console.log("Start game info: ",e);let n=JSON.parse(e);console.log("Given mess: ",n,n.ok),n.ok&&(w(!0),y(!1))}),s.on("end-game",e=>{console.log("clean up state: ",e)}),s.on("user-forfeit",e=>{console.log("user-forfeit socket message: ",e)}),s.on("fetch-saved-game",e=>{try{let t=JSON.parse(e);if(t.ok&&Number.isInteger(t.winner)){console.log("Res win: ",t.winner);let e="unknown";switch(t.winner){case 0:e="draw";break;case 1:e="white";case 2:e="black";default:console.log("Fetched winner: ",t.winner)}"unknown"!==e&&J(e),C(e)}else{var n;console.error("[!!!] Error when fetching saved data: ",null!==(n=t.error)&&void 0!==n?n:"")}}catch(e){console.error("[!!!] Can't fetch saved game data")}}))},[M,u,s]),d.useEffect(()=>{I();let e=localStorage.getItem("@stockchess/useLocalStorage/".concat(r,"-moves"));if(e){let n=JSON.parse(e),t=g(null==l?void 0:l.variant);console.log("[NEW]: ",t,t.fen());try{n.forEach(e=>t.move(e))}catch(e){console.log("[!!!] Error in initializing saved game: ",e)}Q(t)}(async function(){let e=await h({gameID:r});e.ok&&e.data&&(x(1e3*e.data.w),b(1e3*e.data.b),"w"===D.turn()?(w(!0),y(!1)):(w(!1),y(!0)))})()},[]);let z=e=>{console.log("MOVE: ",e),null==s||s.emit("play-chess",JSON.stringify({move:e,id:r}))},B=()=>{null==s||s.emit("end-game",JSON.stringify({id:r}))},G=()=>{console.log("Running init..."),null==s||s.emit("start-game",JSON.stringify({id:r,userId:a,config:l}))},q=()=>{null==s||s.emit("undo",JSON.stringify({id:r}))},I=()=>{let e=(0,m.io)("".concat("http://fall2324w3g9.int3306.freeddns.org"),{autoConnect:!1,reconnection:!0});Z(e),i(e)},Z=e=>{console.log("Fetching saved game..."),e.emit("fetch-saved-game",JSON.stringify({id:r}))},[D,Q]=(0,d.useState)(g(null==l?void 0:l.variant)),[_,L]=(0,f._)({name:"".concat(r,"-is-playing"),defaultValue:!1}),[F,K]=(0,f._)({name:"".concat(r,"-moves"),defaultValue:[]}),[V,T]=(0,d.useState)(),[U,A]=(0,d.useReducer)(p,{check:{}}),W=e=>{console.log(e);let n=D.move(e);if(n){let e;if(K(D.history({verbose:!0})),Q(D),D.inCheck()){let n=D.board().reduce((e,n,t)=>{let o=n.findIndex(e=>e&&"k"===e.type&&e.color===D.turn());return o>=0?"".concat(String.fromCharCode(o+97)).concat(8-t):e},"");e={[n]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}A({check:e}),"b"===D.turn()?(y(!0),w(!1)):(y(!1),w(!0))}return n},H=()=>{var e,n;D.reset(),(null==l?void 0:l.variant)===2&&D.load("bnnqrkrb/pppppppp/8/8/8/8/PPPPPPPP/BNNQRKRB w KQkq - 0 1"),Q(D),B(),K([]),V&&clearTimeout(V),L(!1),x((null!==(e=null==l?void 0:l.timeMode)&&void 0!==e?e:0)*6e4),b((null!==(n=null==l?void 0:l.timeMode)&&void 0!==n?n:0)*6e4),y(!1),w(!1),A({check:void 0})};return{game:D,playing:_,moves:F,winner:N,customSquares:U,wPlayerTimeLeft:v,isWPlayerActive:k,bPlayerTimeLeft:j,isBPlayerActive:S,onPieceDrop:(e,n)=>{if(!_)return!1;let t=W({from:e,to:n,promotion:"q"});return null!==t&&(z(t.from+t.to+(t.promotion?t.promotion:"")),!0)},undoMove:()=>{q(),D.undo(),D.undo(),Q(D),K(D.history({verbose:!0})),A({check:void 0})},startGame:()=>{H(),G(),L(!0)},resetGame:H,forfeitGame:()=>{null==s||s.emit("user-forfeit",JSON.stringify({id:r})),J("black")},prevMove:()=>{let e;let n=Math.max(P-1,0),t=O[n];if(R(n),Q(t),t.inCheck()){let n=t.board().reduce((e,n,o)=>{let r=n.findIndex(e=>e&&"k"===e.type&&e.color===t.turn());return r>=0?"".concat(String.fromCharCode(r+97)).concat(8-o):e},"");e={[n]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}A({check:e})},nextMove:()=>{let e;let n=Math.min(P+1,O.length-1),t=O[n];if(R(n),Q(t),t.inCheck()){let n=t.board().reduce((e,n,o)=>{let r=n.findIndex(e=>e&&"k"===e.type&&e.color===t.turn());return r>=0?"".concat(String.fromCharCode(r+97)).concat(8-o):e},"");e={[n]:{background:"radial-gradient(red, rgba(255,0,0,.8), transparent 70%)",borderRadius:"50%"}}}A({check:e})},socket:s}},x=t(12506),k=t(30118);let w=e=>{let{id:n,name:t}=e;return(0,a.jsx)("div",{className:"hover:opacity-60",children:(0,a.jsx)("div",{className:"w-[60px] h-[60px] border-2",children:(0,a.jsx)(k.Z,{name:t})})})};var j=e=>{let{botList:n,onSelectBot:t}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-bold text-center pt-4",style:{fontSize:"20px"},children:"Ez Bot"}),(0,a.jsx)("div",{className:"w-auto flex row-auto pl-4 flex-wrap",children:n.map(e=>(0,a.jsx)("div",{className:"p-2",onClick:()=>{t(e)},children:(0,a.jsx)(w,{id:e.id,name:e.name})},e.id))})]})},b=t(98998),S=e=>{let{botList:n,onSelectBot:t,bot:o}=e;return(0,a.jsx)("div",{children:(0,a.jsx)("div",{className:"flex pt-4 pb-4",children:(0,a.jsxs)("ul",{className:"max-h-[550px] h-[550px] w-auto overflow-y-auto divide-y border rounded-lg",children:[(0,a.jsx)("div",{className:"w-[450px] text-center font-bold flex-wrap p-4",style:{fontSize:"27px"},children:"Play Chess Against a Computer"}),(0,a.jsx)("div",{className:"h-[300px]",children:(0,a.jsx)(b.Z,{id:o.id,name:o.name,inGame:!1})}),(0,a.jsx)("div",{children:(0,a.jsx)(j,{botList:n,onSelectBot:t})})]})})})},y=t(96215),N=e=>{let{timeLeft:n,going:t,turnIndicator:o}=e,r=(0,d.useRef)(null),[l,s]=(0,d.useState)(Date.now()+n);return(0,d.useEffect)(()=>{t?r.current.start():r.current.pause()},[t]),(0,d.useEffect)(()=>{s(Date.now()+n)},[n]),(0,a.jsx)(y.ZP,{date:l,ref:r,autoStart:!1,intervalDelay:100,precision:1,renderer:e=>{let{minutes:n,seconds:t,milliseconds:r}=e;return(0,a.jsx)("div",{className:"inline-block p-4 text-xl rounded-2xl font-mono "+(o?"bg-white":"bg-[#c8c8c8]"),children:(0,a.jsxs)("h1",{children:[(0,y.Bu)(n),":",(0,y.Bu)(t),".",r/100]})})}})},C=t(71198),P=t(46848),R=t(17369),O=t(91658),E=e=>{let n,{id:t,type:o}=e,{userId:r,name:s}=(0,d.useContext)(O.UserContext);try{var u;n=JSON.parse(null!==(u=localStorage.getItem("config-".concat(t)))&&void 0!==u?u:"")}catch(e){console.error("Can't parse game config: ",e,!1)}let{game:m,playing:f,customSquares:h,winner:p,wPlayerTimeLeft:g,isWPlayerActive:k,bPlayerTimeLeft:w,isBPlayerActive:j,onPieceDrop:b,undoMove:y,startGame:E,resetGame:M,forfeitGame:J,prevMove:z,nextMove:B}=v({type:o,id:t,userId:r,gameConfig:n}),[G,q]=(0,d.useState)([]),[I,Z]=(0,d.useState)({id:"0",name:"shark"}),[D,Q]=(0,d.useState)(!0);return(0,d.useEffect)(()=>{q([{id:"0",name:"shark"},{id:"1",name:"elephant"},{id:"2",name:"owl"},{id:"3",name:"monkey"},{id:"4",name:"penguin"},{id:"5",name:"cat"}])},[]),(0,a.jsxs)("div",{className:"flex p-4 mt-8",children:[(0,a.jsx)("div",{className:"flex justify-center w-2/3",children:(0,a.jsxs)("div",{className:"w-[450px]",children:[(0,a.jsxs)("div",{className:"",children:[(null==n?void 0:n.timeMode)?(0,a.jsx)(N,{timeLeft:w,going:j&&f,turnIndicator:!1}):null,(0,a.jsx)(x.Z,{name:I?I.name:"none",link:I?"/home":"/profile/guest"})]}),!f&&(0,a.jsx)("div",{className:"absolute flex justify-center items-center w-[450px] h-[450px] z-10"}),(0,a.jsx)(l.r,{id:t,onPieceDrop:b,position:m.fen(),customBoardStyle:{borderRadius:"8px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.5)"},customSquareStyles:{...h.check}}),(0,a.jsxs)("div",{className:"",children:[(0,a.jsx)(x.Z,{name:null!=s?s:"Guest",link:"/profile/guest"}),(null==n?void 0:n.timeMode)?(0,a.jsx)(N,{timeLeft:g,going:k&&f,turnIndicator:!0}):null]})]})}),(0,a.jsx)("div",{className:"flex justify-center w-1/3",children:(0,a.jsxs)("div",{children:[f?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.Z,{moves:m.history({verbose:!0}).reverse(),bot:I||{id:"0",name:"shark"}}),"unknown"!==p?(0,a.jsxs)("div",{className:"flex justify-center",children:[(0,a.jsx)(P.Z,{style:{fontSize:"32px"},onClick:z}),(0,a.jsx)(R.Z,{style:{fontSize:"32px"},onClick:B})]}):null]}):(0,a.jsx)(S,{botList:G,onSelectBot:e=>{Z(e)},bot:I||{id:"0",name:"shark"}}),(0,a.jsx)(i,{startGame:E,resetGame:M,forfeitGame:J,undoMove:y})]})}),"unknown"===p?null:(0,a.jsx)(C.Z,{winner:p,isOpen:D,setOpen:Q})]})}}}]);